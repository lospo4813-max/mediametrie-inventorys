<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#E30613">
    <title>M√©diam√©trie Inventory Pro</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap">
    <script src="https://unpkg.com/html5-qrcode@2.3.8/minified/html5-qrcode.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Roboto', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #F5F5F5;
            overflow-x: hidden;
        }

        .screen {
            display: none;
            min-height: 100vh;
        }

        .screen.active {
            display: block;
        }

        /* √âCRAN DE CONFIGURATION */
        .setup-screen {
            position: relative;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            background: url('https://images.unsplash.com/photo-1581094794329-c8112a89af12?w=1920&h=1080&fit=crop') center/cover;
        }

        .setup-screen::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
        }

        .setup-box {
            position: relative;
            z-index: 10;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 24px;
            padding: 40px 30px;
            width: 100%;
            max-width: 420px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
        }

        .logo-container {
            width: 120px;
            height: 120px;
            background: linear-gradient(135deg, #E30613, #FF6B35);
            border-radius: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 24px;
            box-shadow: 0 8px 24px rgba(227, 6, 19, 0.4);
        }

        .logo-m {
            font-size: 70px;
            font-weight: bold;
            color: white;
        }

        .title {
            text-align: center;
            font-size: 36px;
            font-weight: bold;
            background: linear-gradient(135deg, #E30613, #FF6B35);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 8px;
        }

        .subtitle {
            text-align: center;
            font-size: 18px;
            color: #333;
            font-weight: 600;
            margin-bottom: 32px;
        }

        .input-group {
            margin-bottom: 16px;
        }

        .input-label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
        }

        .input {
            width: 100%;
            padding: 16px;
            border: 2px solid #DDD;
            border-radius: 12px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .input:focus {
            outline: none;
            border-color: #E30613;
        }

        .btn-start {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, #E30613, #FF6B35);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 24px;
            box-shadow: 0 4px 12px rgba(227, 6, 19, 0.3);
        }

        /* HEADER */
        .header {
            background: linear-gradient(135deg, #E30613, #FF6B35);
            color: white;
            padding: 20px;
            padding-top: 40px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .header-top {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .header-logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header-logo-box {
            width: 56px;
            height: 56px;
            background: white;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .header-logo-m {
            font-size: 32px;
            font-weight: bold;
            background: linear-gradient(135deg, #E30613, #FF6B35);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header-title {
            font-size: 20px;
            font-weight: bold;
        }

        .user-badge {
            background: rgba(0, 0, 0, 0.2);
            padding: 12px;
            border-radius: 8px;
        }

        .stats-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-top: 12px;
        }

        .stat-box {
            background: rgba(255, 255, 255, 0.2);
            padding: 8px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-number {
            font-size: 20px;
            font-weight: bold;
        }

        .stat-label {
            font-size: 11px;
            opacity: 0.9;
        }

        /* CONTENU */
        .content {
            padding: 20px;
        }

        .section-title {
            font-size: 12px;
            font-weight: bold;
            color: #666;
            letter-spacing: 0.5px;
            margin-bottom: 16px;
        }

        .categories-grid {
            display: grid;
            gap: 12px;
            margin-bottom: 24px;
        }

        .category-card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            display: flex;
            align-items: center;
            gap: 16px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            cursor: pointer;
            transition: all 0.3s;
            border-left: 4px solid;
        }

        .category-card:active {
            transform: scale(0.98);
        }

        .category-card.accessories { border-left-color: #3B82F6; }
        .category-card.tvm3 { border-left-color: #8B5CF6; }
        .category-card.streaming { border-left-color: #10B981; }

        .category-icon {
            font-size: 48px;
        }

        .category-info {
            flex: 1;
        }

        .category-name {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }

        .category-count {
            font-size: 13px;
            color: #666;
            margin-top: 4px;
        }

        /* SCANNER */
        .scanner-header {
            background: linear-gradient(135deg, #E30613, #FF6B35);
            color: white;
            padding: 20px;
            padding-top: 40px;
        }

        .back-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            margin-bottom: 12px;
        }

        .scanner-zone {
            background: white;
            margin: 20px;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        #reader {
            width: 100%;
            border-radius: 12px;
            overflow: hidden;
            margin: 16px 0;
        }

        .scan-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 16px;
        }

        .btn-scan {
            padding: 14px;
            background: linear-gradient(135deg, #E30613, #FF6B35);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
        }

        .btn-stop {
            padding: 14px;
            background: #6B7280;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
        }

        .form-section {
            background: white;
            margin: 20px;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
        }

        .form-input, .form-select {
            width: 100%;
            padding: 14px;
            border: 2px solid #E5E7EB;
            border-radius: 10px;
            font-size: 15px;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: #E30613;
        }

        .btn-add {
            width: 100%;
            padding: 16px;
            background: #10B981;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 16px;
        }

        .status-message {
            padding: 12px;
            border-radius: 8px;
            margin-top: 12px;
            font-weight: 500;
        }

        .status-success {
            background: #D1FAE5;
            color: #065F46;
        }

        .status-warning {
            background: #FEF3C7;
            color: #92400E;
        }

        /* TABLEAU */
        .table-container {
            background: white;
            margin: 20px;
            border-radius: 16px;
            padding: 16px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            overflow-x: auto;
        }

        .table-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 16px;
            color: #333;
        }

        .search-bar {
            width: 100%;
            padding: 14px;
            border: 2px solid #E5E7EB;
            border-radius: 10px;
            font-size: 15px;
            margin-bottom: 16px;
        }

        .inventory-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 600px;
        }

        .inventory-table th {
            background: linear-gradient(135deg, #E30613, #FF6B35);
            color: white;
            padding: 12px;
            text-align: left;
            font-size: 13px;
            font-weight: 600;
            white-space: nowrap;
        }

        .inventory-table td {
            padding: 12px;
            border-bottom: 1px solid #F3F4F6;
            font-size: 14px;
        }

        .btn-delete {
            background: #EF4444;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
        }

        .action-buttons {
            display: grid;
            gap: 12px;
            margin: 20px;
        }

        .btn-export, .btn-sync, .btn-clear {
            width: 100%;
            padding: 16px;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-export {
            background: #10B981;
        }

        .btn-sync {
            background: linear-gradient(135deg, #E30613, #FF6B35);
        }

        .btn-clear {
            background: #EF4444;
        }

        .btn-back-main {
            width: 100%;
            padding: 16px;
            background: #6B7280;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
        }
    </style>
</head>
<body>

<!-- √âCRAN DE CONFIGURATION -->
<div id="setupScreen" class="screen active">
    <div class="setup-screen">
        <div class="setup-box">
            <div class="logo-container">
                <div class="logo-m">M</div>
            </div>
            
            <h1 class="title">M√©diam√©trie</h1>
            <div class="subtitle">INVENTAIRE PRO</div>
            
            <div class="input-group">
                <label class="input-label">Nom *</label>
                <input type="text" id="inputName" class="input" placeholder="Dupont" autocomplete="off">
            </div>
            
            <div class="input-group">
                <label class="input-label">Identifiant *</label>
                <input type="text" id="inputId" class="input" placeholder="MED001" autocomplete="off">
            </div>
            
            <button class="btn-start" onclick="startApp()">Commencer</button>
        </div>
    </div>
</div>

<!-- √âCRAN PRINCIPAL -->
<div id="mainScreen" class="screen">
    <div class="header">
        <div class="header-top">
            <div class="header-logo">
                <div class="header-logo-box">
                    <div class="header-logo-m">M</div>
                </div>
                <div>
                    <div class="header-title">M√©diam√©trie Inventory</div>
                </div>
            </div>
        </div>
        <div class="user-badge">
            <div id="userName"></div>
            <div id="userId"></div>
        </div>
        <div class="stats-container">
            <div class="stat-box">
                <div class="stat-number" id="totalAccessoires">0</div>
                <div class="stat-label">Accessoires</div>
            </div>
            <div class="stat-box">
                <div class="stat-number" id="totalTvm3">0</div>
                <div class="stat-label">TVM3</div>
            </div>
            <div class="stat-box">
                <div class="stat-number" id="totalStreaming">0</div>
                <div class="stat-label">Streaming</div>
            </div>
        </div>
    </div>
    
    <div class="content">
        <div class="section-title">S√âLECTIONNEZ UNE CAT√âGORIE</div>
        
        <div class="categories-grid">
            <div class="category-card accessories" onclick="startScan('accessoires', 'Accessoires', 'üîå')">
                <div class="category-icon">üîå</div>
                <div class="category-info">
                    <div class="category-name">Accessoires</div>
                    <div class="category-count"><span id="countAccessoires">0</span> √©l√©ment(s)</div>
                </div>
            </div>
            
            <div class="category-card tvm3" onclick="startScan('tvm3', 'TVM3', 'üì±')">
                <div class="category-icon">üì±</div>
                <div class="category-info">
                    <div class="category-name">TVM3</div>
                    <div class="category-count"><span id="countTvm3">0</span> √©l√©ment(s)</div>
                </div>
            </div>
            
            <div class="category-card streaming" onclick="startScan('streaming', 'Streaming Meters', 'üì°')">
                <div class="category-icon">üì°</div>
                <div class="category-info">
                    <div class="category-name">Streaming Meters</div>
                    <div class="category-count"><span id="countStreaming">0</span> √©l√©ment(s)</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- √âCRAN SCANNER -->
<div id="scanScreen" class="screen">
    <div class="scanner-header">
        <button class="back-btn" onclick="backToMain()">‚Üê Retour</button>
        <h2 id="scanTitle"></h2>
    </div>
    
    <div class="scanner-zone">
        <div id="reader" style="display:none;"></div>
        <div class="scan-buttons">
            <button class="btn-scan" id="startScan">üì∑ Scanner</button>
            <button class="btn-stop" id="stopScan">üõë Arr√™ter</button>
        </div>
    </div>
    
    <div class="form-section">
        <form id="inventoryForm">
            <div class="form-group">
                <label class="form-label">Nom / Description *</label>
                <input type="text" id="nomAppareil" class="form-input" placeholder="Ex: TVM3 s√©rie X" required>
            </div>
            
            <div class="form-group">
                <label class="form-label">Num√©ro de s√©rie *</label>
                <input type="text" id="numeroSerie" class="form-input" placeholder="Scanner ou saisir" required>
            </div>
            
            <div class="form-group">
                <label class="form-label">√âtat</label>
                <select id="etatAppareil" class="form-select">
                    <option>Fonctionnel</option>
                    <option>En panne</option>
                    <option>En SAV</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">Localisation</label>
                <input type="text" id="localisation" class="form-input" placeholder="Lieu, technicien...">
            </div>
            
            <button type="submit" class="btn-add">Ajouter √† l'inventaire</button>
            <div id="statusMessage"></div>
        </form>
    </div>
    
    <div class="table-container">
        <div class="table-title">üì¶ Inventaire (<span id="inventoryCount">0</span>)</div>
        <input type="text" id="searchBar" class="search-bar" placeholder="üîç Rechercher...">
        <table class="inventory-table">
            <thead>
                <tr>
                    <th>Type</th>
                    <th>Nom</th>
                    <th>N¬∞ S√©rie</th>
                    <th>√âtat</th>
                    <th>Localisation</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>
    
    <div class="action-buttons">
        <button class="btn-export" onclick="exportCSV()">
            <span>üì•</span>
            <span>Exporter CSV</span>
        </button>
        <button class="btn-sync" onclick="syncDatabase()">
            <span>üîÑ</span>
            <span>Synchroniser la base</span>
        </button>
        <button class="btn-clear" onclick="clearInventory()">
            <span>üóëÔ∏è</span>
            <span>Vider l'inventaire</span>
        </button>
        <button class="btn-back-main" onclick="backToMain()">‚Üê Retour au menu</button>
    </div>
</div>

<script>
// VARIABLES GLOBALES
let userData = {};
let currentCategory = '';
let currentCategoryName = '';
let inventaire = [];
let baseAppareils = {};
let html5QrCode;
let filteredItems = []; // Pour g√©rer la suppression correctement
const storageKey = "inventaireMediametrie";

// INITIALISATION
window.onload = function() {
    const saved = localStorage.getItem('mediametrie_user');
    if (saved) {
        userData = JSON.parse(saved);
        document.getElementById('inputName').value = userData.name;
        document.getElementById('inputId').value = userData.id;
    }
    
    // Charger base d'appareils
    if(localStorage.getItem("baseAppareils")){
        baseAppareils = JSON.parse(localStorage.getItem("baseAppareils"));
    }
    
    // Charger inventaire
    inventaire = JSON.parse(localStorage.getItem(storageKey)) || [];
    updateCategoryCounts();
};

// D√âMARRER APP
function startApp() {
    const name = document.getElementById('inputName').value.trim();
    const id = document.getElementById('inputId').value.trim().toUpperCase();
    
    if (!name || !id) {
        alert('‚ùå Veuillez remplir tous les champs');
        return;
    }
    
    userData = { name, id };
    localStorage.setItem('mediametrie_user', JSON.stringify(userData));
    
    document.getElementById('userName').textContent = name;
    document.getElementById('userId').textContent = `ID: ${id}`;
    
    updateCategoryCounts();
    showScreen('mainScreen');
}

// GESTION DES √âCRANS
function showScreen(screenId) {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.getElementById(screenId).classList.add('active');
}

// MISE √Ä JOUR DES COMPTEURS
function updateCategoryCounts() {
    const counts = {
        'Accessoires': 0,
        'TVM3': 0,
        'Streaming Meters': 0
    };
    
    inventaire.forEach(item => {
        if (counts.hasOwnProperty(item.type)) {
            counts[item.type]++;
        }
    });
    
    document.getElementById('countAccessoires').textContent = counts['Accessoires'];
    document.getElementById('countTvm3').textContent = counts['TVM3'];
    document.getElementById('countStreaming').textContent = counts['Streaming Meters'];
    
    document.getElementById('totalAccessoires').textContent = counts['Accessoires'];
    document.getElementById('totalTvm3').textContent = counts['TVM3'];
    document.getElementById('totalStreaming').textContent = counts['Streaming Meters'];
}

// D√âMARRER SCAN
function startScan(category, categoryName, icon) {
    currentCategory = category;
    currentCategoryName = categoryName;
    document.getElementById('scanTitle').textContent = categoryName;
    
    renderTable();
    showScreen('scanScreen');
}

// SCANNER QR CODE
document.getElementById('startScan').addEventListener('click', () => {
    document.getElementById('reader').style.display = 'block';
    html5QrCode = new Html5Qrcode("reader");
    
    Html5Qrcode.getCameras().then(cameras => {
        if(cameras && cameras.length) {
            html5QrCode.start(
                cameras[0].id,
                { fps: 10, qrbox: 250 },
                qrCodeMessage => {
                    document.getElementById('numeroSerie').value = qrCodeMessage;
                    checkDevice(qrCodeMessage);
                    html5QrCode.stop();
                    document.getElementById('reader').style.display = 'none';
                    playBeep();
                }
            ).catch(err => {
                console.error("Erreur scan:", err);
                alert("Erreur lors du scan : " + err);
            });
        }
    }).catch(err => alert("Erreur cam√©ra : " + err));
});

document.getElementById('stopScan').addEventListener('click', () => {
    if(html5QrCode) {
        html5QrCode.stop().then(() => {
            document.getElementById('reader').style.display = 'none';
        }).catch(err => console.error("Erreur arr√™t scan:", err));
    }
});

// V√âRIFIER APPAREIL
function checkDevice(code){
    const statusEl = document.getElementById('statusMessage');
    let found = false;
    
    for (let type in baseAppareils){
        if(baseAppareils[type][code]){
            statusEl.className = 'status-message status-success';
            statusEl.textContent = "‚úÖ Appareil reconnu : " + baseAppareils[type][code];
            document.getElementById('nomAppareil').value = baseAppareils[type][code];
            found = true;
            break;
        }
    }
    
    if(!found) {
        statusEl.className = 'status-message status-warning';
        statusEl.textContent = "‚ö†Ô∏è Appareil inconnu dans la base.";
    }
}

// AJOUTER √Ä L'INVENTAIRE
document.getElementById('inventoryForm').addEventListener('submit', e => {
    e.preventDefault();
    
    const nom = document.getElementById('nomAppareil').value.trim();
    const numero = document.getElementById('numeroSerie').value.trim();
    const etat = document.getElementById('etatAppareil').value;
    const localisation = document.getElementById('localisation').value.trim();
    const date = new Date().toLocaleString('fr-FR');
    
    if(!numero){ 
        alert("Le num√©ro de s√©rie est obligatoire."); 
        return; 
    }
    
    // V√©rifier si le num√©ro de s√©rie existe d√©j√†
    const existing = inventaire.find(item => item.numero === numero);
    if (existing) {
        if (!confirm(`‚ö†Ô∏è Le num√©ro de s√©rie "${numero}" existe d√©j√† dans l'inventaire (${existing.type}).\nVoulez-vous quand m√™me l'ajouter ?`)) {
            return;
        }
    }
    
    inventaire.push({
        type: currentCategoryName,
        nom,
        numero,
        etat,
        localisation,
        date,
        operateur: userData.name
    });
    
    localStorage.setItem(storageKey, JSON.stringify(inventaire));
    renderTable();
    updateCategoryCounts();
    document.getElementById('inventoryForm').reset();
    document.getElementById('statusMessage').textContent = '';
    playBeep();
});

// RECHERCHE
document.getElementById('searchBar').addEventListener('input', e => {
    const query = e.target.value.toLowerCase();
    renderTable(query);
});

// AFFICHER TABLEAU
function renderTable(filter=""){
    const tableBody = document.getElementById('tableBody');
    tableBody.innerHTML = "";
    
    // Filtrer par cat√©gorie actuelle ET par recherche
    filteredItems = inventaire.filter(item => 
        item.type === currentCategoryName &&
        Object.values(item).some(v => String(v).toLowerCase().includes(filter.toLowerCase()))
    );
    
    document.getElementById('inventoryCount').textContent = filteredItems.length;
    
    filteredItems.forEach((item, filteredIndex) => {
        // Trouver l'index r√©el dans inventaire
        const realIndex = inventaire.indexOf(item);
        
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${item.type}</td>
            <td>${item.nom}</td>
            <td>${item.numero}</td>
            <td>${item.etat}</td>
            <td>${item.localisation || '-'}</td>
            <td><button class="btn-delete" onclick="deleteItem(${realIndex})">üóë</button></td>
        `;
        tableBody.appendChild(tr);
    });
    
    if (filteredItems.length === 0) {
        const tr = document.createElement('tr');
        tr.innerHTML = '<td colspan="6" style="text-align:center; padding:24px; color:#999;">Aucun √©l√©ment trouv√©</td>';
        tableBody.appendChild(tr);
    }
}

// SUPPRIMER
function deleteItem(realIndex){
    const item = inventaire[realIndex];
    if(confirm(`Supprimer cet enregistrement ?\n\n${item.nom}\nN¬∞ s√©rie: ${item.numero}`)){
        inventaire.splice(realIndex, 1);
        localStorage.setItem(storageKey, JSON.stringify(inventaire));
        renderTable(document.getElementById('searchBar').value);
        updateCategoryCounts();
        playBeep();
    }
}

// VIDER L'INVENTAIRE
function clearInventory() {
    if (inventaire.length === 0) {
        alert("L'inventaire est d√©j√† vide.");
        return;
    }
    
    if (confirm(`‚ö†Ô∏è ATTENTION !\n\nVoulez-vous vraiment supprimer TOUS les ${inventaire.length} √©l√©ments de l'inventaire ?\n\nCette action est irr√©versible !`)) {
        if (confirm("√ätes-vous vraiment s√ªr ? Cette action ne peut pas √™tre annul√©e.")) {
            inventaire = [];
            localStorage.setItem(storageKey, JSON.stringify(inventaire));
            renderTable();
            updateCategoryCounts();
            alert("‚úÖ Inventaire vid√© avec succ√®s !");
        }
    }
}

// EXPORT CSV
function exportCSV() {
    if(inventaire.length === 0){ 
        alert("Aucune donn√©e √† exporter."); 
        return; 
    }
    
    const csv = [
        ["Type","Nom","Num√©ro de s√©rie","√âtat","Localisation","Date","Op√©rateur"].join(","),
        ...inventaire.map(i => [
            i.type, 
            i.nom, 
            i.numero, 
            i.etat, 
            i.localisation || '', 
            i.date, 
            i.operateur
        ].map(v => '"' + String(v).replace(/"/g,'""') + '"').join(","))
    ].join("\n");

    const blob = new Blob(['\ufeff' + csv], { type: "text/csv;charset=utf-8" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    const timestamp = new Date().toISOString().slice(0,19).replace(/:/g,'-');
    a.download = `inventaire_mediametrie_${timestamp}.csv`;
    a.click();
    URL.revokeObjectURL(url);
    
    playBeep();
    alert(`‚úÖ Export CSV r√©ussi !\n${inventaire.length} √©l√©ment(s) export√©(s)`);
}

// SYNCHRONISER BASE
async function syncDatabase() {
    const confirmSync = confirm("‚ö†Ô∏è Cette action va t√©l√©charger la base de donn√©es des appareils depuis le serveur.\n\nContinuer ?");
    if (!confirmSync) return;
    
    try {
        const res = await fetch("https://elailam.fr/inventaire/appareils.json?_=" + Date.now());
        if(!res.ok) throw new Error(`Erreur HTTP ${res.status}`);
        
        const data = await res.json();
        
        // V√©rifier que les donn√©es sont au bon format
        if (typeof data !== 'object') {
            throw new Error("Format de donn√©es invalide");
        }
        
        baseAppareils = data;
        localStorage.setItem("baseAppareils", JSON.stringify(baseAppareils));
        playBeep();
        
        // Compter le nombre d'appareils
        let totalDevices = 0;
        for (let category in baseAppareils) {
            if (typeof baseAppareils[category] === 'object') {
                totalDevices += Object.keys(baseAppareils[category]).length;
            }
        }
        
        alert(`‚úÖ Base mise √† jour avec succ√®s !\n\n${totalDevices} appareil(s) dans la base.`);
    } catch(e) {
        console.error("Erreur sync:", e);
        alert("‚ö†Ô∏è √âchec de la mise √† jour de la base :\n\n" + e.message + "\n\nV√©rifiez votre connexion internet et l'URL du serveur.");
    }
}

// RETOUR MENU
function backToMain() {
    if(html5QrCode) {
        html5QrCode.stop().catch(() => {});
    }
    document.getElementById('searchBar').value = '';
    updateCategoryCounts();
    showScreen('mainScreen');
}

// BIP SONORE
function playBeep() {
    try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.frequency.value = 800;
        oscillator.type = 'sine';
        
        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.15);
        
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.15);
    } catch (error) {
        console.log('Beep error:', error);
    }
}
</script>

</body>
</html>
